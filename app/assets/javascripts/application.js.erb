// This is a manifest file that'll be compiled into including all the files listed below.
// Add new JavaScript/Coffee code in separate files in this directory and they'll automatically
// be included in the compiled file accessible from http://example.com/assets/application.js
// It's not advisable to add code directly here, but if you do, it'll appear at the bottom of the
// the compiled file.
//
//= require jquery
//= require jquery_ujs
//= require jquery_ui
//= require jquery_tmpl
//= require jquery_validate
//= require jquery.tablednd
//= require_self

SUBMARINE = {
  changeListHandler: function(event){
    var rowIndex = $(event.target).parent('li');
    var data = { moved_issue_id: rowIndex.attr("data-id"), backlog_list: [], sprint_backlog_list: [] };
    data.predecessor_id = $(rowIndex).prev() && $(rowIndex).prev().attr("data-id");
    $('ul#backlog_list > li').each(function(i, li){
      data.backlog_list.push($(li).attr("data-id")); 
    });
    $('ul#sprint_backlog_list > li').each(function(i, li){
      data.sprint_backlog_list.push($(li).attr("data-id")); 
    });
    $.ajax({
          type: 'POST',
          url: SUBMARINE.changeListURL,
          data: data,
          error: function(){window.alert(SUBMARINE.messages.save_failed)}    
          })
  },
  toggleDescription: function(event){
    console.log($(this).hasClass("short"));
    console.log($(this).parents("li").find("span").css("height", div_height+15));
    if($(this).hasClass("short")){
      $(this).removeClass("short");
      var div_height = $(this).height();
      console.log(div_height);
      $(this).parents("li").css("height", div_height+15);
    } else {
      $(this).addClass("short").parents("li").css("height", "auto");
    }
  },
  showStoryPointsSum: function(event){
    var list_type = $(event.target).parent('li').parent('ul')[0].id;
    var rowIndex = $(list_type).children.length;
    var sum = 0;
    var elements;
    if(list_type == "backlog_list") {
      elements = $('ul#backlog_list > li > span.story_points');
    } else if(list_type == "sprint_backlog_list") {
      elements = $('ul#sprint_backlog_list > li > span.story_points');
    }
    for(i = 0; i < rowIndex; i++) {
      value = $(elements[i]).html();
      if(value == "1/2"){
        value = 0.5;
      } else if(!value){
        value = 0;
      } else {
        value = parseInt(value, 10);
        }i
      sum += value;
      $(event.target).attr("title", "Summe: " + sum);
    }
  },
  messages: {}
}

$(document).ready(function(){
  $("ul > li > div div.description").bind("click", SUBMARINE.toggleDescription);
  $("ul > li > span.story_points").bind("mouseover", SUBMARINE.showStoryPointsSum);
});
